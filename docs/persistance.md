---
layout: page
title: 文件持久化
permalink: /文件持久化
---

# 文件持久化

由于我们使用了容器技术，所以当实例销毁后，一般情况下容器内的所有文件会丢失，但我们对一些目录做了特殊处理。

## work 目录

用户账号创建后，我们会在云端为用户分配一个 TA 独有的目录。用户启用实例后，系统会将用户的云端目录挂载到容器中的 work 目录上。

这样，用户在 `work` 目录中的所有文件都会与云端同步，也就是说，当用户归还实例后，他在 work 目录中的文件并不会丢失。

除了 work 目录中的所有其他文件，在实例被归还后都会立即被销毁。
{:.fe-error-block}

## 同步机制

强烈建议你了解一下 work 目录的同步机制，这可能可以帮助你更好地使用 Featurize 中的实例，甚至极大地提高你的训练速度。
{:.fe-warning-block}

**文件读取**

当你使用某个实例时，你在 work 目录中的所有文件会立即出现在左侧的文件浏览器中，但这并不意味着他们全部都已经被同步到本地了。事实上，容器只是加载了一个云端的文件列表，并没有真正同步文件内容。而当你真正「访问」到某个文件后，容器才会开始从云端获取对应文件内容。

多次访问同一个文件只有第一次会从云端同步，之后都会直接从本地读取，所以你不用担心性能问题。

![文件读取过程](/asset/read-file.png)

**文件写入**

文件写入和同步云端是「同步」的，如果你往 work 目录中写入一个 200MB 的文件，那么执行的顺序是这样的：

1. 往云端磁盘中写入 200MB 文件
2. 往本地磁盘中写入 200MB 文件
3. 提示用户写入成功

所以，往 work 目录中写文件的性能相比一般的磁盘文件写入是有性能折损的，因为需要额外发一次网络请求。

![文件写入过程](/asset/write-file.png)

## 最佳实践

当了解过同步机制后，我们可以得出以下的一些最佳实践：

1. **不要往 `work` 目录中存放训练数据**。 因为读取 work 目录中的文件有网络请求，如果将很大的训练数据存放至 work 目录中，会导致训练的第一轮会非常慢（我们切身体会），因为这意味着要下载整个数据集到本地。你应该参考如何使用数据集。
2. **避免在训练过程中频繁得往 work 目录中写入大量文件**。 因为 work 目录写文件就意味着网络请求，所以频繁的写入操作会影响训练的性能。举一个极端的例子：如果一轮训练只需要 2 分钟，而生成的模型的大小有 1G，并且每轮训练完毕都会存储模型，那么可能大部分时间都花在了模型的存储上。
